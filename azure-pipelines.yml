trigger:
  branches:
    include:
      - main

schedules:
  - cron: "0 6 * * *"  # 6 AM UTC daily
    displayName: Daily Run
    branches:
      include:
        - main
    always: true

variables:
  - group: EmailSecrets  # Contains EMAIL_USER and EMAIL_PASS

pool:
  name: Default  # Use your agent pool name

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '18.x'
    displayName: 'Install Node.js'

  - script: |
      npm ci
    displayName: 'Install Dependencies'

  # ðŸ‘‡ Cypress run with mochawesome (overwrite=true to prevent merging issues)
  - script: |
      npx cypress run --spec "cypress/e2e/**/*.cy.js" ^
      --reporter mochawesome ^
      --reporter-options reportDir=cypress/reports,overwrite=true,html=true,json=true
    displayName: 'Run Cypress Tests'

  # ðŸ‘‡ Send Email with mochawesome report (no need to merge now)
  - script: |
      node send-email.js
    env:
      EMAIL_USER: $(EMAIL_USER)
      EMAIL_PASS: $(EMAIL_PASS)
    displayName: 'Send Cypress Report Email'
