steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '18.x'
    displayName: 'Install Node.js'

  - script: |
      npm ci
    displayName: 'Install Dependencies'

  - powershell: |
      Remove-Item -Path "cypress/reports" -Recurse -Force -ErrorAction SilentlyContinue
    displayName: 'Clean Previous Reports'

  - script: |
      npx cypress run --spec "cypress/e2e/**/*.cy.js" --reporter mochawesome --reporter-options reportDir=cypress/reports,overwrite=false,html=true,json=true
    displayName: 'Run Cypress Tests'

  - script: |
      npx mochawesome-merge cypress/reports/*.json > cypress/reports/mochawesome.json
    displayName: 'Merge Mochawesome Reports'

  - script: |
      node send-email.js
    env:
      EMAIL_USER: $(EMAIL_USER)
      EMAIL_PASS: $(EMAIL_PASS)
    displayName: 'Send Cypress Report Email'
